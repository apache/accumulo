#! /usr/bin/env bash
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

function print_usage {
  cat <<EOF
Usage: accumulo-cluster <command> (<argument> ...) [<option> ...]

Options:
  --dry-run                  Prints information and commands, but does not execute them

Commands:
  create-config              Creates cluster config
  restart                    Restarts the Accumulo cluster
  start-here                 Starts all services on this node
  stop-here                  Stops all services on this node
  start [--all | [--manager] [--gc] [--monitor] [--tservers [group]] [--sservers [group]] [--compactors [group]]
                             Starts Accumulo cluster
  stop [--all | [--manager] [--gc] [--monitor] [--tservers [group]] [--sservers [group]] [--compactors [group]]
                             Stops Accumulo cluster
  kill [--all | [--manager] [--gc] [--monitor] [--tservers [group]] [--sservers [group]] [--compactors [group]]
                             Kills Accumulo cluster
EOF
}

function parse_sub_args {
  ARG_ALL=0
  ARG_MANAGER=0
  ARG_GC=0
  ARG_MONITOR=0
  ARG_TSERVER=0
  ARG_TSERVER_GROUP=""
  ARG_SSERVER=0
  ARG_SSERVER_GROUP=""
  ARG_COMPACTOR=0
  ARG_COMPACTOR_GROUP=""

  PARSE_OUTPUT=$(getopt --long "all,manager,gc,monitor,tservers:,sservers:,compactors:" -n 'accumulo-cluster' -- "$@")
  eval set -- "$PARSE_OUTPUT"

  while true; do
    case "$1" in
      --all)
        ARG_ALL=1
        shift 1
        ;;
      --manager)
        ARG_MANAGER=1
        shift 1
        ;;
      --gc)
        ARG_GC=1
        shift 1
        ;;
      --monitor)
        ARG_MONITOR=1
        shift 1
        ;;
      --tservers)
        ARG_TSERVER=1
        if [ -z "$2" ]; then
          shift 1
        else
          ARG_TSERVER_GROUP="$2"
          shift 2
        fi
        ;;
      --sservers)
        ARG_SSERVER=1
        if [ -z "$2" ]; then
          shift 1
        else
          ARG_SSERVER_GROUP="$2"
          shift 2
        fi
        ;;
      --compactors)
        ARG_COMPACTOR=1
        if [ -z "$2" ]; then
          shift 1
        else
          ARG_COMPACTOR_GROUP="$2"
          shift 2
        fi
        ;;
      --)
        shift
        break
        ;;
      *)
        echo "Unhandled option: $1"
        print_usage
        exit 1
        ;;
    esac
  done

  # All and any of the others are mutually exclusive
  if [[ $ARG_ALL == 1 && ($ARG_MANAGER == 1 ||
    $ARG_GC == 1 || $ARG_MONITOR == 1 || $ARG_TSERVER == 1 ||
    $ARG_SSERVER == 1 || $ARG_COMPACTOR == 1) ]]; then
    echo "--all cannot be used with other options"
    print_usage
    exit 1
  fi

  # Handle the case where no args were passed
  if [[ $ARG_MANAGER == 0 && $ARG_GC == 0 &&
    $ARG_MONITOR == 0 && $ARG_TSERVER == 0 &&
    $ARG_SSERVER == 0 && $ARG_COMPACTOR == 0 ]]; then
    ARG_ALL=1
  fi

  export ARG_ALL
  export ARG_MANAGER
  export ARG_GC
  export ARG_MONITOR
  export ARG_TSERVER
  export ARG_TSERVER_GROUP
  export ARG_SSERVER
  export ARG_SSERVER_GROUP
  export ARG_COMPACTOR
  export ARG_COMPACTOR_GROUP
}

function invalid_args {
  echo -e "Invalid arguments: $1\n"
  print_usage 1>&2
  exit 1
}

function parse_fail {
  echo "Failed to parse ${conf}/cluster.yaml"
  exit 1
}

isDebug() {
  [[ $DEBUG == 1 ]]
}

debug() {
  isDebug && echo "${@@P}"
}

debugAndRun() {
  debug "$@"
  if ! isDebug; then
    # shellcheck disable=SC2294
    eval "${@@P}"
  fi
}

function parse_config {

  if [[ ! -f ${conf}/cluster.yaml ]]; then
    echo "ERROR: A 'cluster.yaml' file was not found at ${conf}/cluster.yaml"
    echo "Please make sure it exists and is configured with the host information. Run 'accumulo-cluster create-config' to create an example configuration."
    exit 1
  fi

  trap 'rm -f "$CONFIG_FILE"' EXIT
  CONFIG_FILE=$(mktemp) || exit 1
  ${accumulo_cmd} org.apache.accumulo.core.conf.cluster.ClusterConfigParser "${conf}"/cluster.yaml "$CONFIG_FILE" || parse_fail
  #shellcheck source=/dev/null
  . "$CONFIG_FILE"
  debug "Parsed config:" && cat "$CONFIG_FILE"
  rm -f "$CONFIG_FILE"

  if [[ -z $MANAGER_HOSTS ]]; then
    echo "ERROR: managers not found in ${conf}/cluster.yaml"
    exit 1
  fi

  if [[ -z $COMPACTOR_GROUPS ]]; then
    echo "WARN: No compactor groups configured"
  else
    for group in $COMPACTOR_GROUPS; do
      Q="COMPACTOR_HOSTS_${group}"
      if [[ -z ${!Q} ]]; then
        echo "WARN: External compactor group $group configured, but no compactors configured for it"
      fi
    done
  fi

  tservers_found="false"
  if [[ -z $TSERVER_GROUPS ]]; then
    echo "WARN: No tablet server groups configured"
  else
    for group in $TSERVER_GROUPS; do
      G="TSERVER_HOSTS_${group}"
      if [[ -z ${!G} ]]; then
        echo "WARN: tablet server group $group configured, but no hosts configured for it"
      else
        tservers_found="true"
      fi
    done
  fi

  if [[ $tservers_found != "true" ]]; then
    echo "ERROR: There are no tablet servers configured, Accumulo requires at least 1 tablets server to host system tables"
    exit 1
  fi

  if [[ -n $SSERVER_GROUPS ]]; then
    for group in $SSERVER_GROUPS; do
      G="SSERVER_HOSTS_${group}"
      if [[ -z ${!G} ]]; then
        echo "WARN: scan server group $group configured, but no hosts configured for it"
      fi
    done
  fi

  unset manager1
  manager1=$(echo "${MANAGER_HOSTS}" | cut -d" " -f1)

  if [[ -z $MONITOR_HOSTS ]]; then
    echo "WARN: monitors not found in ${conf}/cluster.yaml, using first manager host $manager1"
    MONITOR_HOSTS=$manager1
  fi

  if [[ -z $GC_HOSTS ]]; then
    echo "WARN: gc not found in ${conf}/cluster.yaml, using first manager host $manager1"
    GC_HOSTS=$manager1
  fi

}

function control_service() {
  control_cmd="$1"
  host="$2"
  service="$3"
  group="$4"

  S="${service^^}S_PER_HOST_${group}"
  servers_per_host="${!S}"

  if [[ $host == localhost || $host == "$(hostname -s)" || $host == "$(hostname -f)" || "$(hostname -I)" =~ $host ]]; then
    #
    # The server processes take arguments using "-o". Always add the "general.process.bind.addr" argument
    # using the value of $host
    #
    if [[ $# -gt 4 ]]; then
      debugAndRun ACCUMULO_CLUSTER_ARG="${servers_per_host}" "${bin}/accumulo-service" "$service" "$control_cmd" "-o" "general.process.bind.addr=$host" "${@:5}"
    else
      debugAndRun ACCUMULO_CLUSTER_ARG="${servers_per_host}" "${bin}/accumulo-service" "$service" "$control_cmd" "-o" "general.process.bind.addr=$host"
    fi
  else
    if [[ $# -gt 4 ]]; then
      EXTRA_ARGS="${*:5}"
      debugAndRun "$SSH" "$host" "bash -c 'ACCUMULO_CLUSTER_ARG=${servers_per_host} ${bin}/accumulo-service \"$service\" \"$control_cmd\" \"-o\" \"general.process.bind.addr=$host\" $EXTRA_ARGS '"
    else
      debugAndRun "$SSH" "$host" "bash -c 'ACCUMULO_CLUSTER_ARG=${servers_per_host} ${bin}/accumulo-service \"$service\" \"$control_cmd\" \"-o\" \"general.process.bind.addr=$host\"'"
    fi
  fi
}

function alter_services() {
  unset DISPLAY
  operation="$1"

  if [[ $operation == "start" ||
    $operation == "stop" ||
    $operation == "kill" ]]; then
    echo "Invalid operation: $operation"
    exit 1
  fi

  if [[ $ARG_ALL == 1 && $operation == "stop" ]]; then
    echo "Stopping Accumulo cluster..."
    if ! isDebug; then
      if ! ${accumulo_cmd} admin stopAll; then
        echo "Invalid password or unable to connect to the manager"
        echo "Initiating forced shutdown in 15 seconds (Ctrl-C to abort)"
        sleep 10
        echo "Initiating forced shutdown in  5 seconds (Ctrl-C to abort)"
      else
        echo "Accumulo shut down cleanly"
        echo "Utilities and unresponsive servers will shut down in 5 seconds (Ctrl-C to abort)"
      fi
      sleep 5
    fi
  elif [[ $ARG_ALL == 1 && $operation == "kill" ]]; then
    echo "Killing Accumulo cluster..."
  fi

  if [[ $ARG_ALL == 1 || $ARG_TSERVER == 1 ]]; then
    tserver_groups=$TSERVER_GROUPS
    if [[ -n $ARG_TSERVER_GROUPS ]]; then
      tserver_groups=$ARG_TSERVER_GROUPS
    fi
    for group in $tserver_groups; do
      echo "Starting tablet servers for group $group"
      count=1
      hosts="TSERVER_HOSTS_${group}"
      for tserver in ${!hosts}; do
        echo -n "."
        control_service "$operation" "$tserver" tserver "${group}" "-o" "tserver.group=$group"
        if ((++count % 72 == 0)); then
          echo
          wait
        fi
      done
    done
    echo "done"
  fi

  if [[ $ARG_ALL == 1 || $ARG_MANAGER == 1 ]]; then
    for manager in $MANAGER_HOSTS; do
      control_service "$operation" "$manager" manager "default"
    done
  fi

  if [[ $ARG_ALL == 1 || $ARG_GC == 1 ]]; then
    for gc in $GC_HOSTS; do
      control_service "$operation" "$gc" gc "default"
    done
  fi

  if [[ $ARG_ALL == 1 || $ARG_MONITOR == 1 ]]; then
    for monitor in $MONITOR_HOSTS; do
      control_service "$operation" "$monitor" monitor "default"
    done
  fi

  if [[ $ARG_ALL == 1 || $ARG_SSERVER == 1 ]]; then
    sserver_groups=$SSERVER_GROUPS
    if [[ -n $ARG_SSERVER_GROUPS ]]; then
      sserver_groups=$ARG_SSERVER_GROUPS
    fi
    for group in $sserver_groups; do
      echo "Starting scan servers for group $group"
      hosts="SSERVER_HOSTS_${group}"
      for sserver in ${!hosts}; do
        control_service "$operation" "$sserver" sserver "${group}" "-o" "sserver.group=$group"
      done
    done
  fi

  if [[ $ARG_ALL == 1 || $ARG_COMPACTOR == 1 ]]; then
    compactor_groups=$COMPACTOR_GROUPS
    if [[ -n $ARG_COMPACTOR_GROUP ]]; then
      compactor_groups=$ARG_COMPACTOR_GROUP
    fi
    for group in $compactor_groups; do
      echo "Starting compactors for group $group"
      hosts="COMPACTOR_HOSTS_${group}"
      for compactor in ${!hosts}; do
        control_service "$operation" "$compactor" compactor "${group}" "-o" "compactor.group=$group"
      done
    done
  fi

  if [[ $ARG_ALL == 1 && ($operation == "stop" || $operation == "kill") ]]; then
    if ! isDebug; then
      echo "Cleaning all server entries in ZooKeeper"
      ${accumulo_cmd} org.apache.accumulo.server.util.ZooZap -manager -tservers -compactors -sservers
    fi
  fi

}

function start_here() {

  local_hosts="$(hostname -a 2>/dev/null) $(hostname) localhost 127.0.0.1 $(hostname -I)"

  for group in $TSERVER_GROUPS; do
    echo "Starting tablet servers for group $group"
    for host in $local_hosts; do
      G="TSERVER_HOSTS_${group}"
      for tserver in ${!G}; do
        if echo "$tserver" | grep -q "^${host}\$"; then
          control_service "start" "$tserver" tserver "${group}" "-o" "tserver.group=$group"
        fi
      done
    done
  done

  for host in $local_hosts; do
    for manager in $MANAGER_HOSTS; do
      if echo "$manager" | grep -q "^${host}\$"; then
        control_service "start" "$host" manager "default"
        break
      fi
    done
  done

  for host in $local_hosts; do
    for gc in $GC_HOSTS; do
      if echo "$gc" | grep -q "^${host}\$"; then
        control_service "start" "$host" gc "default"
        break
      fi
    done
  done

  for host in $local_hosts; do
    for monitor in $MONITOR_HOSTS; do
      if echo "$monitor" | grep -q "^${host}\$"; then
        control_service "start" "$host" monitor "default"
        break
      fi
    done
  done

  for group in $SSERVER_GROUPS; do
    echo "Starting scan servers for group $group"
    for host in $local_hosts; do
      G="SSERVER_HOSTS_${group}"
      for sserver in ${!G}; do
        if echo "$sserver" | grep -q "^${host}\$"; then
          control_service "start" "$sserver" sserver "${group}" "-o" "sserver.group=$group"
        fi
      done
    done
  done

  for group in $COMPACTOR_GROUPS; do
    echo "Starting compactors for group $group"
    for host in $local_hosts; do
      Q="COMPACTOR_HOSTS_${group}"
      for compactor in ${!Q}; do
        if echo "$compactor" | grep -q "^${host}\$"; then
          control_service "start" "$compactor" compactor "${group}" "-o" "compactor.group=$group"
        fi
      done
    done
  done

}

function stop_here() {
  # Determine hostname without errors to user
  hosts_to_check=("$(hostname -a 2>/dev/null | head -1)" "$(hostname -f)")

  if echo "${TSERVER_HOSTS}" | grep -Eq 'localhost|127[.]0[.]0[.]1'; then
    if ! isDebug; then
      ${accumulo_cmd} admin stop localhost
    else
      debug "Stopping tservers on localhost via admin command"
    fi
  else
    for host in "${hosts_to_check[@]}"; do
      for group in $TSERVER_GROUPS; do
        G="TSERVER_HOSTS_${group}"
        for tserver in ${!G}; do
          if echo "$tserver" | grep -q "$host"; then
            if ! isDebug; then
              ${accumulo_cmd} admin stop "$host"
            else
              debug "Stopping tservers on $host via admin command"
            fi
          fi
        done
      done
    done
  fi

  for host in "${hosts_to_check[@]}"; do
    for end_cmd in "stop" "kill"; do
      for svc in gc manager monitor; do
        control_service $end_cmd "$host" $svc "default"
      done
      for group in $TSERVER_GROUPS; do
        G="TSERVER_HOSTS_${group}"
        for tserver in ${!G}; do
          control_service $end_cmd "$tserver" tserver "${group}" "-o" "tserver.group=$group"
        done
      done
      for group in $SSERVER_GROUPS; do
        G="SSERVER_HOSTS_${group}"
        for sserver in ${!G}; do
          control_service $end_cmd "$sserver" sserver "${group}" "-o" "sserver.group=$group"
        done
      done
      for group in $COMPACTOR_GROUPS; do
        Q="COMPACTOR_HOSTS_${group}"
        for compactor in ${!Q}; do
          control_service $end_cmd "$host" compactor "${group}" "-o" "compactor.group=$group"
        done
      done
    done
  done
}

function main() {

  if [[ -z $1 ]]; then
    invalid_args "<command> cannot be empty"
  fi

  # Resolve base directory
  SOURCE="${BASH_SOURCE[0]}"
  while [ -h "${SOURCE}" ]; do
    bin="$(cd -P "$(dirname "${SOURCE}")" && pwd)"
    SOURCE="$(readlink "${SOURCE}")"
    [[ ${SOURCE} != /* ]] && SOURCE="${bin}/${SOURCE}"
  done
  bin="$(cd -P "$(dirname "${SOURCE}")" && pwd)"
  basedir=$(cd -P "${bin}"/.. && pwd)
  conf="${ACCUMULO_CONF_DIR:-${basedir}/conf}"

  accumulo_cmd="${bin}/accumulo"
  SSH='ssh -qnf -o ConnectTimeout=2'

  # Copy input arguments into new array
  # removing any options
  DEBUG=0
  i=0
  declare -a program_args
  for arg in "$@"; do
    if [[ $arg == "--dry-run" ]]; then
      DEBUG=1
    else
      program_args[i++]="$arg"
    fi
  done

  debug "debug: ${DEBUG} args: ${program_args[*]}"

  case "${program_args[0]}" in
    create-config)
      if [[ -f "$conf"/cluster.yaml ]]; then
        echo "ERROR : ${conf}/cluster.yaml already exists, not overwriting"
        exit 1
      fi
      cat <<EOF >"$conf"/cluster.yaml
manager:
  - localhost

monitor:
  - localhost

gc:
  - localhost

tserver:
  default:
    servers_per_host: 1
    hosts:
      - localhost

compactor:
  default:
    servers_per_host: 1
    hosts:
      - localhost

sserver:
  default:
    servers_per_host: 1
    hosts:
      - localhost

EOF
      ;;
    restart)
      parse_config
      ARG_ALL=1
      alter_services stop
      alter_services kill
      # Make sure the JVM has a chance to fully exit
      sleep 1
      alter_services start
      ;;
    start)
      parse_config
      shift
      parse_sub_args "${program_args:1}"
      alter_services start
      ;;
    stop)
      parse_config
      shift
      parse_sub_args "${program_args:1}"
      alter_services stop
      ;;
    kill)
      parse_config
      shift
      parse_sub_args "${program_args:1}"
      alter_services kill
      ;;
    start-here)
      parse_config
      start_here
      ;;
    stop-here)
      parse_config
      stop_here
      ;;
    *)
      invalid_args "${program_args[0]} is an invalid <command>"
      ;;
  esac
}

main "$@"
